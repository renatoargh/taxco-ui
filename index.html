<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>B. M. Silva - Gerenciador de Tarefas</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/gritter.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="container"></div>

    <script type="application/javascript" src="/js/jquery.min.js"></script>
    <script type="application/javascript" src="/js/underscore.min.js"></script>
    <script type="application/javascript" src="/js/backbone.min.js"></script>
    <script type="application/javascript" src="/js/modelBinder.min.js"></script>
    <script type="application/javascript" src="/js/deepModel.min.js"></script>
    <script type="application/javascript" src="/js/bootstrap.min.js"></script>
    <script type="application/javascript" src="/js/gritter.min.js"></script>
    <script type="application/javascript" src="/js/moment.min.js"></script>
    <script type="application/javascript" src="/js/momentPtBr.js"></script>
    <script type="application/javascript" src="/js/marked.min.js"></script>
    <script type="application/javascript" src="/js/bootbox.min.js"></script>

    <script type="text/template" id="logInTemplate">
        <div class="row logotipo">
            <div class="col-sm-12 text-center">
                <img width="200px" height="113px" src="/img/logotipo-bmsilva.png" alt="B. M. Silva Construções Ltda" />
            </div>
        </div>
        <div class="row">
            <div class="email form-group col-sm-offset-4 col-sm-4">
                <label class="control-label" id="emailLabel" for="email">
                    Email
                </label>
                <input class="form-control" type="text" id="email" name="email" placeholder="Email"></input>
                <span class="help-block"></span>
            </div>
        </div>
        <div class="row">
            <div class="password form-group col-sm-offset-4 col-sm-4">
                <label class="control-label" id="passwordLabel" for="password">
                    Senha
                </label>
                <input class="form-control" type="password" id="password" name="password" placeholder="Senha"></input>
                <span class="help-block"></span>
            </div>
        </div>
        <div class="row">
            <div class="col-sm-offset-4 col-sm-4">
                <button id="signUp" class="btn btn-link pull-left">
                    Quero me cadastrar
                </button>
                <button id="login" class="btn btn-success pull-right">
                    ENTRAR&nbsp;
                    <i class="glyphicon glyphicon-ok"></i>
                </button>
            </div>
        </div>

        <div class="modal fade" id="signUpModal" tabindex="-1" role="dialog" aria-labelledby="signUpModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only">Fechar</span>
                        </button>

                        <h4 class="modal-title" id="signUpModalLabel">
                            <i class="glyphicon glyphicon-user" />&nbsp;
                            Novo Cadastro
                        </h4>
                    </div>

                    <div class="modal-body">
                        <div class="row">
                            <div class="name form-group col-sm-12">
                                <label class="control-label" id="nameLabel" for="name">
                                    Nome
                                </label>
                                <input class="form-control" type="text" id="name" name="name" placeholder="Nome"></input>
                                <span class="help-block"></span>
                            </div>
                            <div class="email form-group col-sm-12">
                                <label class="control-label" id="emailLabel" for="email">
                                    Email
                                </label>
                                <input class="form-control" type="text" id="email" name="email" placeholder="Email"></input>
                                <span class="help-block"></span>
                            </div>
                            <div class="telefone form-group col-sm-12">
                                <label class="control-label" id="telefoneLabel" for="telefone">
                                    Telefone (com DDD)
                                </label>
                                <input class="form-control" type="text" maxlength="10" id="telefone" name="telefone" placeholder="Telefone (com DDD)"></input>
                                <span class="help-block"></span>
                            </div>
                            <div class="password form-group col-sm-12">
                                <label class="control-label" id="passwordLabel" for="password">
                                    Senha
                                </label>
                                <input class="form-control" type="password" id="password" name="password" placeholder="Senha"></input>
                                <span class="help-block"></span>
                            </div>
                            <div class="passwordConfirmation form-group col-sm-12">
                                <label class="control-label" id="passwordConfirmationLabel" for="passwordConfirmation">
                                    Confirme sua senha
                                </label>
                                <input class="form-control" type="password" id="passwordConfirmation" name="passwordConfirmation" placeholder="Confirme sua senha"></input>
                                <span class="help-block"></span>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button id="sendSignUpForm" type="button" class="btn btn-primary">Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <script type="text/template" id="commentTemplate">
        <div class="row" style="margin-bottom: 10px;">
            <div class="col-sm-12">
                <div class="media">
                    <div class="media-left">
                        <img class="media-object img-rounded" width="32px" height="32px" src="<%= gravatar %>" alt="<%= owner.name %>">
                    </div>
                    <div class="media-body">
                        <h5 class="media-heading"><%= owner.name %> em <%= moment(createdAt).format('DD/MM/YYYY [às] HH:mm') %> (<%= moment(createdAt).fromNow() %>)</h5>
                        <%= content %>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <script type="text/template" id="listTasksTemplate">
        <div class="row logotipo">
            <div class="col-sm-12 text-center">
                <img width="200px" height="113px" src="/img/logotipo-bmsilva.png" alt="B. M. Silva Construções Ltda" />
            </div>
        </div>
        <div class="row">
            <div class="col-sm-offset-3 col-sm-6">
                <strong class="userName"></strong>
            </div>
        </div>
        <div class="row formActions">
            <div class="col-sm-offset-3 col-sm-6">
                <button id="newTask" class="btn btn-primary btn-sm pull-left">
                    Nova Tarefa&nbsp;
                    <i class="glyphicon glyphicon-plus"></i>
                </button>
                <button id="listUsers" class="btn btn-primary btn-sm pull-left">
                    Usuários&nbsp;
                    <i class="glyphicon glyphicon-user"></i>
                </button>
                <button id="logout" class="btn btn-primary btn-sm pull-left">
                    Sair&nbsp;
                    <i class="glyphicon glyphicon glyphicon-log-out"></i>
                </button>
                <!-- <div class="dropdown pull-right">
                  <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="filter" data-toggle="dropdown">
                    <i class="glyphicon glyphicon-filter"></i>&nbsp;
                    Filtrar&nbsp;
                    <span class="caret"></span>
                  </button>
                  <ul class="dropdown-menu" role="menu" aria-labelledby="filter">
                    <li role="presentation">
                        <a role="menuitem" tabindex="-1" href="#">
                            <i class="glyphicon glyphicon-ok" />&nbsp;
                            Criadas por mim
                        </a>
                    </li>
                    <li role="presentation">
                        <a role="menuitem" tabindex="-1" href="#">
                            <i class="glyphicon glyphicon-ok" />&nbsp;
                            Atribuidas a mim
                        </a>
                    </li>
                    <li role="presentation">
                        <a role="menuitem" tabindex="-1" href="#">
                            <i class="glyphicon glyphicon-ok" />&nbsp;
                            Abertas
                        </a>
                    </li>
                    <li role="presentation">
                        <a role="menuitem" tabindex="-1" href="#">
                            <i class="glyphicon glyphicon-ok" />&nbsp;
                            Fechadas
                        </a>
                    </li>
                  </ul>
                </div> -->
            </div>
        </div>
        <div class="row" id="tasks"></div>
        <div class="modal fade" id="newTaskModal" tabindex="-1" role="dialog" aria-labelledby="newTaskModalLabel" aria-hidden="true"></div>
        <div class="modal fade" id="listUsersModal" tabindex="-1" role="dialog" aria-labelledby="listUsersModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only">Fechar</span>
                        </button>

                        <h4 class="modal-title" id="listUsersModalLabel">
                            <i class="glyphicon glyphicon-user"></i>
                            Usuários
                        </h4>
                    </div>

                    <div class="modal-body">
                        <table id="users" class="table table-striped table-hover table-condensed">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Telefone</th>
                                    <th>Perfil</th>
                                    <th>Habilitado</th>
                                    <th>Última Interação</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div class="modal-footer">
                        <span id="savingUser" class="pull-left">
                            Salvando...
                        </span>
                        <button type="button" class="btn btn-primary" data-dismiss="modal">Ok</button>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <script type="text/template" id="taskModalTemplate">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Fechar</span>
                    </button>

                    <h4 class="modal-title" id="newTaskModalLabel">
                        <i class="glyphicon glyphicon-file"></i>&nbsp;
                        <%= title %>
                    </h4>
                </div>

                <div class="modal-body">
                    <div class="edit">
                        <div class="row">
                            <div class="form-group col-sm-8">
                                <label class="control-label" id="titleLabel" for="title">
                                    Título
                                </label>
                                <input class="form-control" type="text" id="title" name="title" placeholder="Título"></input>
                            </div>
                            <div class="reviewRequestFormGroup form-group col-sm-2">
                                <label class="control-label" id="reviewRequestLabel" for="reviewRequest">
                                    Revisão
                                </label>
                                <select class="form-control" type="text" id="reviewRequest" name="reviewRequest" placeholder="Revisão"></input>
                                    <option value="true">SIM</option>
                                    <option value="false">NÃO</option>
                                </select>
                                <span class="help-block"></span>
                            </div>
                            <div class="isOpenFormGroup form-group col-sm-2">
                                <label class="control-label" id="isOpenLabel" for="isOpen">
                                    Status
                                </label>
                                <select class="form-control" type="text" id="isOpen" name="isOpen" placeholder="Status"></input>
                                    <option value="true">ABERTA</option>
                                    <option value="false">FECHADA</option>
                                </select>
                                <span class="help-block"></span>
                            </div>
                            <div class="form-group col-sm-12">
                                <label class="control-label" id="descriptionLabel" for="description">
                                    Descrição
                                </label>
                                <textarea name="description" id="description" cols="30" rows="10" class="form-control" placeholder="Descrição"></textarea>
                            </div>

                            <div class="form-group col-sm-6">
                                <label class="control-label" id="assignedToLabel" for="assignedTo">
                                    Reponsável
                                </label>
                                <select class="form-control" id="assignedTo" name="assignedToId"></select>
                            </div>
                            <div class="form-group col-sm-6">
                                <label class="control-label" id="visibleToLabel" for="visibleTo">
                                    Visível Para
                                </label>
                                <select class="form-control" id="visibleTo" name="visibleToId" multiple></select>
                            </div>
                        </div>
                    </div>
                    <div class="visualize">
                        <h4 id="taskTitle"></h4>
                        <span id="taskDescription"></span>
                    </div>
                </div>

                <div class="modal-footer">
                    <button id="visualizeNewTask" type="button" class="btn btn-default pull-left">Visualizar</button>
                    <button id="editNewTask" type="button" class="displayNone btn btn-default pull-left">Editar</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    <button id="saveTask" type="button" class="btn btn-primary">Salvar</button>
                </div>
            </div>
        </div>
    </script>

    <script type="text/template" id="userTemplate">
        <td class="name">
            <span class="visualize name"></span>
            <input type="text" width="100%" maxlength="75" class="edit name"></input>
        </td>
        <td class="email">
            <span class="email visualize"></span>
            <input type="text" width="100%" maxlength="50" class="email edit"></input>
        </td>
        <td class="telefone">
            <span class="telefone visualize"></span>
            <input type="text" maxlength="10" width="100%" maxlength="50" class="telefone edit"></input>
        </td>
        <td class="role">
            <span class="role visualize"></span>
            <select class="role edit">
                <option value="user">Usuário</option>
                <option value="admin">Administrador</option>
            </select>
        </td>
        <td class="enabled">
            <span class="enabled visualize"></span>
            <select class="enabled edit">
                <option value="true">SIM</option>
                <option value="false">NÃO</option>
            </select>
        </td>
        <td class="lastInteraction">
            <span class="lastInteraction visualize"></span>
            <button class="save edit btn btn-xs btn-primary">
                Salvar&nbsp;
                <i class="glyphicon glyphicon-floppy-disk" />
            </button>
        </td>
    </script>
    <script type="text/template" id="taskTemplate">
        <div class="task col-sm-offset-3 col-sm-6">
            <h4 class="taskToggler">
                <i class="glyphicon glyphicon-chevron-right"></i>&nbsp;
                <span class="title"></span>
                <sup class="reviewRequest">
                    <small class="text-info">
                        REVISÃO SOLICITADA
                    </small>
                </sup>
                <sup class="newTask displayNone">
                    <small class="text-info">
                        NOVA
                    </small>
                </sup>
            </h4>
            <span class="details hidden">
                <div class="description"></div>
                <hr />
                <div class="comments"></div>
                <small class="task-information text-muted">
                    <span class="isOpen"></span><br />
                    Criado por
                    <strong>
                        <span class="owner text-muted" />
                    </strong>
                    em
                    <span class="createdAt"></span>
                    (<span class="createdAtFromNow"></span>).
                    <span class="assignedTo" />
                    <span class="visibility" />
                </small>
                <div class="actions">
                    <button class="btn btn-xs btn-primary pull-left edit">
                        Editar&nbsp;
                        <i class="glyphicon glyphicon-pencil"></i>
                    </button>
                    <button class="btn btn-xs btn-primary pull-left comment">
                        Comentar&nbsp;
                        <i class="glyphicon glyphicon-comment"></i>
                    </button>
                    <button class="btn btn-xs btn-primary pull-left notify">
                        Notificar&nbsp;
                        <i class="glyphicon glyphicon-bullhorn"></i>
                    </button>
                    <button class="btn btn-xs btn-primary pull-left requestReview">
                        Solicitar Revisão&nbsp;
                        <i class="glyphicon glyphicon-ok"></i>
                    </button>
                    <button class="btn btn-xs btn-danger pull-right delete">
                        Apagar&nbsp;
                        <i class="glyphicon glyphicon-trash"></i>
                    </button>
                    <br style="clear: both;" />
                </div>
            </span>
            <div class="editTaskModal modal fade" tabindex="-1" role="dialog" aria-hidden="true"></div>
        </div>
    </script>

    <script>
    $(function() {
        function pretty(array, lastSeparator){
            if(typeof lastSeparator === 'undefined') {
                lastSeparator = 'e';
            }

            return array.toString().replace(/,/g, ', ').replace(/,\s([^,]+)$/, ' ' + lastSeparator + ' $1');
        };

        function isLocalhost() {
            return [
                'localhost'
            ].indexOf(window.location.hostname) > -1;
        }

        function gravatar(emailMd5, options) {
            return 'http://gravatar.com/avatar/' + emailMd5 + '?d=identicon&f=y';
        }

        var baseUrl = 'http://api.sisgest.bmsilva.com.br';

        if(isLocalhost()) {
            baseUrl = 'http://localhost:9090';
        }

        function showPrompt(message, callback) {
            bootbox.prompt(message, callback);
        }

        function showConfirm(message, callback) {
            bootbox.confirm([
                '<h3>Confirmação</h3>',
                message
            ].join(''), callback);
        }

        function showSuccess(message, title) {
            return showMessage({
                text: message || '',
                title: title || 'Sucesso',
                type: 'success'
            });
        }

        var mensagemDeErroPadrao = 'Um erro ocorreu!';
        function showError(message, title) {
            if(typeof message === 'undefined' || typeof message === 'object') {
                if(title === 'canceled') {
                    // Mensagem de erro proveniente de cancelamento do ajax, não é necessário exibir
                    return;
                }

                if(message && message.responseJSON && message.responseJSON.message && message.responseJSON.message !== '') {
                    message = message.responseJSON.message;
                } else if(message && message.statusText && message.statusText === 'canceled') {
                    // Mensagem de erro proveniente de cancelamento do ajax, não é necessário exibir
                    return;
                } else {
                    message = mensagemDeErroPadrao;
                }
            }

            if(typeof title === 'undefined' || title === 'error' || typeof title !== 'string') {
                title = 'Erro';
            }

            return showMessage({
                text: message || mensagemDeErroPadrao,
                title: title || 'Erro',
                type: 'error'
            });
        }

        function showInfo(message, title) {
            return showMessage({
                text: message || '',
                title: title || 'Informação',
                type: 'info'
            });
        }

        function showMessage(params) {
            if(!params.message) {
                console.warn && console.warn('Não foi informada uma mensagem para a notificação');
            }

            return $.gritter.add({
                title: params.title || '',
                text: params.text || '',
                time: 3000,
                class_name: {
                    info: 'gritter-info',
                    error: 'gritter-error',
                    success: 'gritter-success',
                }[params.type || 'info']
            });
        }

        var currentUserKey = 'currentUser';

        function getCurrentUser() {
            var currentUser = window.localStorage.getItem(currentUserKey);
            return currentUser ? JSON.parse(currentUser) : null;
        }

        function setCurrentUser(user) {
            removeCurrentUser();

            var currentUser = JSON.stringify(user);
            window.localStorage.setItem(currentUserKey, currentUser);
        }

        function removeCurrentUser() {
            window.localStorage.removeItem(currentUserKey);
        }

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                var user = getCurrentUser(),
                    isTaxcoRequest = settings.url.indexOf(baseUrl) === 0;

                if(isTaxcoRequest && user && user.credentials) {
                    xhr.setRequestHeader("Authorization", user.credentials);
                }
            }
        });

        var LogInView = Backbone.View.extend({
            initialize: function() {
                this.model = new Backbone.Model();
                this.modelBinder = new Backbone.ModelBinder();
            },
            template: _.template($('#logInTemplate').html()),
            el: '.container',
            render: function() {
                this.$el.html(this.template());
                this.modelBinder.bind(this.model, this.el);
            },

            events: {
                'click button#login': 'login',
                'click button#signUp': 'signUp',
                'click button#sendSignUpForm': 'sendSignUpForm'
            },

            login: function() {
                var user = this.model,
                    credentials = 'Basic ' + btoa([
                        user.get('email'),
                        user.get('password')
                    ].join(':'));

                removeCurrentUser();

                var get = $.ajax({
                    type: 'GET',
                    url: baseUrl + '/users/me',
                    beforeSend: function(request) {
                        request.setRequestHeader("Authorization", credentials);
                    }
                });

                get.done(function(user) {
                    user.credentials = credentials;
                    setCurrentUser(user);

                    router.navigate('/tasks', {
                        trigger: true
                    });
                });

                get.fail(function() {
                    showMessage({
                        type: 'error',
                        title: 'Erro',
                        text: [
                            'Email ou senha não encontrados.',
                            'O seu acesso só estará disponível após liberação pelo moderador.'
                        ].join(' ')
                    });
                });
            },

            signUp: function(e) {
                $('#signUpModal').modal('show');
            },

            sendSignUpForm: function(e) {
                var $signUpModal = $('#signUpModal'),
                    _this = this;

                removeCurrentUser();

                if(this.model.get('password') !== this.model.get('passwordConfirmation')) {
                    return showMessage({
                        type: 'error',
                        text: 'As senhas não coincidem'
                    });
                }

                var post = $.ajax({
                    type: 'POST',
                    url: baseUrl + '/users',
                    data: _.pick(this.model.attributes, 'name', 'email', 'telefone', 'password')
                });

                post.done(function() {
                    $signUpModal.modal('hide');

                    _this.model.set({
                        id: null,
                        name: '',
                        email: '',
                        password: '',
                        telefone: '',
                        passwordConfirmation: ''
                    });

                    showMessage({
                        type: 'success',
                        title: 'Sucesso',
                        text: [
                            'Seu cadastro foi recebido e será analisado.',
                            'Em breve você receberá um email com instruções de login.'
                        ].join(' ')
                    });
                });

                post.fail(function() {
                    showMessage({
                        type: 'error',
                        title: 'Erro',
                        text: 'Algo deu errado'
                    });
                })
            },
        });

        var TaskView = Backbone.View.extend({
            initialize: function(task) {
                this.model = new Backbone.DeepModel(task);
                this.modelBinder = new Backbone.ModelBinder();
            },
            template: _.template($('#taskTemplate').html()),
            commentTemplate: _.template($('#commentTemplate').html()),
            taskModalTemplate: _.template($('#taskModalTemplate').html()),
            close: function() {
                // remover views filhas se houver
                this.modelBinder.unbind();
            },
            render: function(container) {
                var user = getCurrentUser(),
                    taskContainer = $('<div />'),
                    _this = this;

                if(!user) {
                    return router.navigate('/', {
                        trigger: true
                    });
                }

                this.setElement(taskContainer);
                container.append(taskContainer);
                this.$el.html(this.template());
                this.$el.find('.editTaskModal').html(this.taskModalTemplate({
                    title: 'Editar Tarefa'
                }));

                if(user.role !== 'admin') {
                    this.$el.find('button.edit').hide();
                    this.$el.find('button.delete').hide();
                    this.$el.find('button.notify').hide();
                }

                this.modelBinder.bind(this.model, this.$el, {
                    title: [{
                        selector: 'span.title',
                        elAttribute: 'html'
                    }],
                    reviewRequest: [{
                        selector: 'sup.reviewRequest',
                        elAttribute: 'class',
                        converter: function(direction, reviewRequest) {
                            reviewRequest = _this.model.get('reviewRequest');
                            var assignedToMe = user.id === _this.model.get('assignedToId'),
                                iAmTheOwner = user.id === _this.model.get('ownerId'),
                                shouldShow = (assignedToMe || iAmTheOwner) && reviewRequest;

                            return shouldShow ? '' : 'displayNone';
                        }
                    }, {
                        selector: 'button.requestReview',
                        elAttribute: 'class',
                        converter: function(direction, reviewRequest) {
                            reviewRequest = _this.model.get('reviewRequest');
                            var assignedToMe = user.id === _this.model.get('assignedToId');/*,
                                shouldShow = assignedToMe && reviewRequest;*/

                            return assignedToMe ? '' : 'displayNone';
                        }
                    }, {
                        selector: 'button.requestReview',
                        elAttribute: 'disabled',
                        converter: function(direction, reviewRequest) {
                            reviewRequest = _this.model.get('reviewRequest');
                            return reviewRequest ? 'disabled' : false;
                        }
                    }],
                    isOpen: [{
                        selector: '.isOpen',
                        elAttribute: 'class',
                        converter: function(direction, value) {
                            return value ? 'label label-danger' : 'label label-success';
                        }
                    }, {
                        selector: '.isOpen',
                        converter: function(direction, value) {
                            value = value === 'true' || value === 1;
                            return value ? 'Aberta' : 'Fechada';
                        }
                    }],
                    'owner.name': {
                        selector: '.owner',
                        elAttribute: 'html'
                    },
                    'assignedTo.name': {
                        selector: 'span.assignedTo',
                        elAttribute: 'html',
                        converter: function(direction, value) {
                            return value ? ('Atribuído a <strong>' + value + '<strong />.') : '';
                        }
                    },
                    description: {
                        selector: 'div.description',
                        elAttribute: 'html',
                        converter: function(direction, value) {
                            return marked(value);
                        }
                    },
                    createdAt: [{
                        selector: '.createdAt',
                        elAttribute: 'html',
                        converter: function(direction, value) {
                            return new moment(value).format('L [às] HH:mm');
                        }
                    }, {
                        selector: '.createdAtFromNow',
                        elAttribute: 'html',
                        converter: function(direction, value) {
                            return new moment(value).fromNow();
                        }
                    }]
                });
            },

            events: {
                'click .taskToggler': 'toggleTaskDetails',
                'click button.edit': 'editTask',
                'click button.delete': 'deleteTask',
                'click button.comment': 'commentTask',
                'click button.notify': 'notifyUsers',
                'click button.requestReview': 'requestReview'
            },

            areDetailsHidden: true,

            requestReview: function(e) {
                e.preventDefault();

                var _this = this,
                    mensagem = [
                        'Deseja realmente solicitar revisão?<br />',
                        'O criador desta tarefa será notificado.'
                    ].join('');

                showConfirm(mensagem, function(resultado) {
                    if(!resultado) {
                        return;
                    }

                    var put = $.ajax({
                        url: baseUrl + '/tasks/' + _this.model.get('id') + '/request-review',
                        type: 'PUT'
                    });

                    put.success(function() {
                        showSuccess('Revisão solicitada!');
                        _this.$el.find('button.requestReview').prop('disabled', true);
                    });

                    put.fail(showError);
                });
            },

            notifyUsers: function(e) {
                e.preventDefault();

                var _this = this;

                showConfirm('Deseja realmente notificar os usuário envolvidos nesta tarefa?', function(resultado) {
                    if(!resultado) {
                        return;
                    }

                    var put = $.ajax({
                        url: baseUrl + '/tasks/' + _this.model.get('id') + '/notify',
                        type: 'PUT'
                    });

                    put.done(function() {
                        showSuccess('Notificações enviadas!');
                    });

                    put.fail(showError);
                });
            },

            commentTask: function(e) {
                e.preventDefault();

                var _this = this;

                showPrompt('Deixe seu comentário', function(commentText) {
                    if(!commentText) {
                        return;
                    }

                    var put = $.ajax({
                        url: baseUrl + '/tasks/' + _this.model.get('id') + '/comments',
                        type: 'PUT',
                        data: {
                            content: commentText
                        }
                    });

                    put.done(function() {
                        showSuccess('Comentário registrado com sucesso!');

                        var $comments = _this.$el.find('.comments'),
                            currentUser = getCurrentUser() || {},
                            comment = {
                                owner: {
                                    name: currentUser.name || '',
                                },
                                content: commentText,
                                createdAt: new Date(),
                                gravatar: gravatar(currentUser.emailMd5 || '')
                            }

                        $comments.append(_this.commentTemplate(comment));
                    });

                    put.fail(showError);
                });
            },

            deleteTask: function(e) {
                var _this = this;

                showConfirm([
                    'Deseja realmente apagar a tarefa "<strong>',
                    this.model.get('title'),
                    '"</strong> e todos os dados associados a ela?<br />',
                    'Esta ação não pode ser desfeita!'
                ].join(''), function(resultado) {
                    if(!resultado) {
                        return;
                    }

                    var del = $.ajax({
                        url: baseUrl + '/tasks/' + _this.model.get('id'),
                        type: 'DELETE'
                    });

                    del.done(function() {
                        showSuccess('Tarefa apagada com êxito!');
                        _this.close();
                        _this.$el.remove();
                    });

                    del.fail(showError);
                });
            },

            editTask: function(e) {
                var _this = this,
                    taskBackUp = _.extend({}, this.model.attributes),
                    saved = false,
                    currentMode = 'visualize',
                    editModelBinder,
                    $editTaskModal = this.$el.find('.editTaskModal'),
                    $visualize = $editTaskModal.find('#visualizeNewTask'),
                    getEnabledUsers = $.getJSON(baseUrl + '/users?enabled=true'),
                    getTask = $.getJSON(baseUrl + '/tasks/' + _this.model.get('id')),
                    when = $.when(getEnabledUsers, getTask);

                function toggleMode() {
                    if(currentMode === 'visualize') {
                        _this.$el.find('.edit').show();
                        _this.$el.find('.visualize').hide();
                        currentMode = 'edit';
                    } else {
                        _this.$el.find('.edit').hide();
                        _this.$el.find('.visualize').show();
                        currentMode = 'visualize';
                    }
                }

                toggleMode();
                $visualize.on('click', toggleMode);

                when.done(function(users, task) {
                    users = users[0];
                    task = task[0];

                    task.visibleToId = task.visibleTo.map(function(user) {
                        return user.id;
                    });

                    if(task.isPublic) {
                        task.visibleToId.push('ALL');
                    }

                    _this.model.set('visibleToId', task.visibleToId);
                    _this.model.set('isOpen', task.isOpen);

                    var $assignedTo = $editTaskModal.find('select#assignedTo'),
                        $visibleTo = $editTaskModal.find('select#visibleTo'),
                        $saveTask = $editTaskModal.find('button#saveTask');

                    $assignedTo.html('');
                    $visibleTo.html('');

                    users.forEach(function(user) {
                        $assignedTo.append($('<option />').val(user.id).html(user.name));
                        $visibleTo.append($('<option />').val(user.id).html(user.name));
                    });

                    $assignedTo.prepend($('<option />').val('').html('NINGUÉM'));
                    $visibleTo.prepend($('<option />').val('ALL').html('TODOS'));

                    $editTaskModal.on('shown.bs.modal', function() {
                        editModelBinder = new Backbone.ModelBinder();
                        editModelBinder.bind(_this.model, $editTaskModal, {
                            title: 'input#title',
                            reviewRequest: {
                                selector: 'select#reviewRequest',
                                converter: function(direction, value) {
                                    if(value === 1) {
                                        value = 'true';
                                    }

                                    if(value === 0) {
                                        value = 'false';
                                    }

                                    if(direction === 'ModelToView') {
                                        return value.toString();
                                    } else {
                                        return value === 'true';
                                    }
                                }
                            },
                            isOpen: {
                                selector: 'select#isOpen',
                                converter: function(direction, value) {
                                    if(direction === 'ModelToView') {
                                        return value.toString();
                                    } else {
                                        return value.toString() === 'true' || value.toString() === '1';
                                    }
                                }
                            },
                            description: [{
                                selector: 'textarea#description',
                                converter: function(direction, value) {
                                    return value;
                                }
                            }, {
                                selector: '#taskDescription',
                                elAttribute: 'html',
                                converter: function(direction, value) {
                                    return marked(value);
                                }
                            }],
                            visibleToId: 'select#visibleTo',
                            assignedToId: {
                                selector: 'select#assignedTo',
                                converter: function(direction, value) {
                                    if(direction === 'ModelToView') {
                                        return value;
                                    } else {
                                        if(value === '') {
                                            return null;
                                        }

                                        return value;
                                    }
                                }
                            }
                        });
                    });

                    $saveTask.on('click', function() {
                        var put = $.ajax({
                            url: baseUrl + '/tasks/' + _this.model.get('id'),
                            type: 'PUT',
                            data: _this.model.attributes
                        });

                        put.done(function() {
                            saved = true;
                        });

                        put.fail(function() {
                            showMessage({
                                type: 'error',
                                title: 'Erro',
                                text: 'Algo deu errado...'
                            });
                        });

                        put.complete(function() {
                            $editTaskModal.modal('hide');
                        });
                    });

                    $editTaskModal.on('hidden.bs.modal', function() {
                        if(saved === false) {
                            _this.model.set(taskBackUp);
                        }

                        $editTaskModal.off();
                        editModelBinder.unbind();
                    });

                    $editTaskModal.modal('show');
                });

                when.fail(function() {
                    showMessage({
                        type: 'error',
                        title: 'Erro',
                        text: 'Algo deu errado...'
                    });
                });
            },

            toggleTaskDetails: function() {
                var _this = this,
                    $task = this.$el.find('.task'),
                    $details = this.$el.find('.details'),
                    $icon = this.$el.find('.taskToggler i.glyphicon');

                if(!$task.hasClass('opened-task')) {
                    $.ajax({
                        url: baseUrl + '/tasks/' + _this.model.get('id') + '/mark-visualized',
                        type: 'PUT'
                    });
                }

                if(!this.model.get('visibilityLoaded')) {
                    var get = $.getJSON(baseUrl + '/tasks/' + _this.model.get('id') + '/visibility');

                    get.done(function(visibility) {
                        if(!visibility.length) {
                            return;
                        }

                        var $visibilityInformation = $('<span/>'),
                            text;

                        if(visibility.length > 1) {
                            text = $('<span>Visível a outros</span> <strong><span class="allowedPeople">' + visibility.length + '</span></strong> <span>usuários.</span>');

                            var $allowedPeople = text.find('.allowedPeople');
                            $allowedPeople.attr('title', pretty(visibility.map(function(visibleTo) {
                                return visibleTo.user.name;
                            })));
                            $allowedPeople.tooltip();
                        } else {
                            text = 'Visível para <strong>' + visibility[0].user.name + '</strong>.';
                        }

                        $task.find('.task-information').append(text);
                    });

                    get.fail(showError);

                    this.model.set('visibilityLoaded', true);
                }

                if(!this.model.get('commentsLoaded')) {
                    var get = $.getJSON(baseUrl + '/tasks/' + _this.model.get('id') + '/comments');

                    get.done(function(comments) {
                        var $comments = _this.$el.find('.comments');

                        comments.forEach(function(comment) {
                            comment.gravatar = gravatar(comment.owner.emailMd5);
                            $comments.append(_this.commentTemplate(comment));
                        });
                    });

                    get.fail(showError);

                    this.model.set('commentsLoaded', true);
                }

                $details.toggleClass('hidden', !this.areDetailsHidden);
                $task.toggleClass('opened-task', !this.areDetailsHidden);
                $icon.toggleClass('glyphicon-chevron-right', !this.areDetailsHidden);

                $details.toggleClass('show', this.areDetailsHidden);
                $task.toggleClass('opened-task', this.areDetailsHidden);
                $icon.toggleClass('glyphicon-chevron-down', this.areDetailsHidden);

                this.areDetailsHidden = !this.areDetailsHidden;
            }
        });

        var UserView = Backbone.View.extend({
            initialize: function(user) {
                this.model = new Backbone.Model(user);
                this.modelBinder = new Backbone.ModelBinder();
            },
            template: _.template($('#userTemplate').html()),
            render: function() {
                var rootElement = $('<tr class="user" />');
                rootElement.one('click', this.toggleMode.bind(this));

                this.setElement(rootElement);
                this.$el.html(this.template());
                $('table#users tbody').append(this.$el);

                this.modelBinder.bind(this.model, this.el, {
                    name: [{
                        selector: '.visualize.name',
                        elAttribute: 'html',
                        converter: function(direction, value) {
                            return value;
                        }
                    }, {
                        selector: '.edit.name',
                        converter: function(direction, value) {
                            if(direction === 'ModelToView') {
                                return value || '';
                            } else {
                                return value.trim();
                            }
                        }
                    }],
                    email: [{
                        selector: '.visualize.email',
                        elAttribute: 'html',
                        converter: function(direction, value) {
                            return value;
                        }
                    }, {
                        selector: '.edit.email',
                        converter: function(direction, value) {
                            if(direction === 'ModelToView') {
                                return value || '';
                            } else {
                                return value.trim();
                            }
                        }
                    }],
                    telefone: [{
                        selector: '.visualize.telefone',
                        elAttribute: 'html',
                        converter: function(direction, value) {
                            function formatarTelefone(texto) {
                                if(!texto || texto.length < 10) {
                                    return texto;
                                }

                                texto = texto.trim().replace(/\(/g, "").replace(/\)/g, "").replace(/\s/g, "").replace(/-/g, "");
                                var i = (texto.length === 11 ? 1 : 0);
                                return "(" + texto.substr(0, 2) + ") " + texto.substr(2, 4 + i) + "-" + texto.substr(6 + i, 4);
                            }

                            return formatarTelefone(value);
                        }
                    }, {
                        selector: '.edit.telefone',
                        converter: function(direction, value) {
                            if(direction === 'ModelToView') {
                                return value || '';
                            } else {
                                return value.trim();
                            }
                        }
                    }],
                    enabled: [{
                        selector: '.visualize.enabled',
                        elAttribute: 'html',
                        converter: function(direction, value) {
                            if(direction === 'ModelToView') {
                                return value ? 'SIM' : 'NÃO'
                            }
                        }
                    }, {
                        selector: '.visualize.enabled',
                        elAttribute: 'class',
                        converter: function(direction, value) {
                            if(direction === 'ModelToView') {
                                return value ? 'text-success' : 'text-danger'
                            }
                        }
                    }, {
                        selector: '.edit.enabled',
                        converter: function(direction, value) {
                            if(direction === 'ModelToView') {
                                if(typeof value === 'undefined' || value === null) {
                                    return 'false';
                                }

                                return value.toString();
                            } else {
                                return value === 'true';
                            }
                        }
                    }],
                    role: [{
                        selector: '.visualize.role',
                        elAttribute: 'html',
                        converter: function(direction, value) {
                            if(direction === 'ModelToView') {
                                return {
                                    'admin': 'Administrador',
                                    'user': 'Usuário'
                                }[value];
                            } else {
                                return value;
                            }
                        }
                    }, {
                        selector: '.edit.role',
                        converter: function(direction, value) {
                            if(direction === 'ModelToView') {
                                if(!value) {
                                    return 'user';
                                }

                                return value;
                            } else {
                                return value;
                            }
                        }
                    }],
                    lastInteraction: {
                        selector: 'span.lastInteraction',
                        elAttribute: 'html',
                        converter: function(direction, value) {
                            if(!value) {
                                return;
                            }

                            return new moment(value).format('L HH:mm:ss');
                        }
                    }
                });
            },

            events: {
                'click button.save': 'saveUser'
            },

            saveUser: function(e) {
                var _this = this,
                    $savingUser = $('#savingUser');

                $savingUser.show();

                var put = $.ajax({
                    url: baseUrl + '/users/' + this.model.get('id'),
                    type: 'PUT',
                    data: this.model.attributes
                });

                put.done(function() {
                    $savingUser.hide();
                    _this.toggleMode();
                    _this.$el.one('click', _this.toggleMode.bind(_this));
                });

                put.fail(function() {
                    showMessage({
                        type: 'error',
                        title: 'Erro',
                        text: 'Ocorreu algum problema ao salvar as alterações no usuário'
                    });
                });
            },

            currentMode: 'visualize',
            toggleMode: function(e) {
                if(this.currentMode === 'visualize') {
                    this.$el.find('.edit').show();
                    this.$el.find('.visualize').hide();
                    this.currentMode = 'edit';
                } else {
                    this.$el.find('.edit').hide();
                    this.$el.find('.visualize').show();
                    this.currentMode = 'visualize';
                }
            },
        });

        var ListTasksView = Backbone.View.extend({
            initialize: function() {
                this.modelBinder = new Backbone.ModelBinder();
            },
            template: _.template($('#listTasksTemplate').html()),
            taskModalTemplate: _.template($('#taskModalTemplate').html()),
            el: '.container',
            _render: function(tasks) {
                var user = getCurrentUser();

                if(!user) {
                    return router.navigate('/', {
                        trigger: true
                    });
                }

                var _this = this;
                this.$el.empty();
                this.$el.html(this.template());
                this.$el.find('#newTaskModal').html(this.taskModalTemplate({
                    title: 'Nova Tarefa'
                }));

                if(user.role !== 'admin') {
                    this.$el.find('button#newTask').hide();
                    this.$el.find('button#listUsers').hide();
                }

                tasks.forEach(function(task) {
                    var taskView = new TaskView(task);
                    taskView.render(_this.$el.find('#tasks'));
                });

                this.$el.find('.userName').html(user.name);

                this.modelBinder.unbind();
                this.modelBinder.bind(this.model, this.el);
            },
            render: function() {
                var user = getCurrentUser();

                if(!user) {
                    return router.navigate('/', {
                        trigger: true
                    });
                }

                var _this = this,
                    get = $.getJSON(baseUrl + '/tasks');

                this.model = new Backbone.Model();

                get.done(function(tasks) {
                    _this._render(tasks);
                });

                get.fail(function(err) {
                    showMessage({
                        type: 'error',
                        title: 'Erro',
                        text: 'Algo deu errado...'
                    });
                });
            },

            events: {
                'click button#listUsers': 'listUsers',
                'click button#newTask': 'newTask',
                'click #newTaskModal .modal-footer #visualizeNewTask': 'visualizeNewTask',
                'click #newTaskModal .modal-footer #editNewTask': 'editNewTask',
                'click #newTaskModal .modal-footer #saveTask': 'saveTask',
                'click #logout': 'logout'
            },

            logout: function(e) {
                removeCurrentUser();
                location.reload(true); // Para resolver aparente delay de retirar do ls o usuário logado

                // router.navigate('/', {
                //     trigger: true
                // });
            },

            saveTask: function(e) {
                var _this = this,
                    post = $.ajax({
                        url: baseUrl + '/tasks',
                        type: 'POST',
                        data: _.pick(this.model.attributes, [
                            'title',
                            'description',
                            'assignedToId',
                            'visibleToId',
                            'isOpen'
                        ])
                    });

                post.done(function() {
                    var $newTask = _this.$el.find('#newTaskModal');
                    $newTask.modal('hide');

                    showMessage({
                        type: 'success',
                        title: 'Sucesso',
                        text: 'Tarefa salva!'
                    });

                    _this.render();
                });

                post.fail(function() {
                    showMessage({
                        type: 'error',
                        title: 'Erro',
                        text: 'Algo deu errado...'
                    });
                });
            },

            editNewTask: function(e) {
                this.$el.find('#newTaskModal .modal-body .edit').show();
                this.$el.find('#newTaskModal .modal-footer #visualizeNewTask').show();

                this.$el.find('#newTaskModal .modal-body .visualize').hide();
                this.$el.find('#newTaskModal .modal-footer #editNewTask').hide();
            },

            visualizeNewTask: function(e) {
                var title = this.model.get('title'),
                    description = this.model.get('description');

                this.$el.find('#newTaskModal .modal-body #taskTitle').html(title);
                this.$el.find('#newTaskModal .modal-body #taskDescription').html(marked(description || ''));

                this.$el.find('#newTaskModal .modal-body .edit').hide();
                this.$el.find('#newTaskModal .modal-footer #visualizeNewTask').hide();

                this.$el.find('#newTaskModal .modal-body .visualize').show();
                this.$el.find('#newTaskModal .modal-footer #editNewTask').show();
            },

            newTask: function(e) {
                var _this = this,
                    get = $.getJSON(baseUrl + '/users?enabled=true');

                get.done(function(users) {
                    var $newTask = _this.$el.find('#newTaskModal'),
                        $assignedTo = $newTask.find('select#assignedTo'),
                        $reviewRequest = $newTask.find('select#reviewRequest'),
                        $isOpen = $newTask.find('select#isOpen'),
                        $visibleTo = $newTask.find('select#visibleTo');

                    $assignedTo.html('');
                    $visibleTo.html('');
                    $isOpen.val('true');
                    $reviewRequest.val('false');
                    _this.model.set('isOpen', 'true');

                    users.forEach(function(user) {
                        $assignedTo.append($('<option />').val(user.id).html(user.name));
                        $visibleTo.append($('<option />').val(user.id).html(user.name));
                    });

                    $assignedTo.prepend($('<option />').html('NINGUÉM'));
                    $visibleTo.prepend($('<option />').val('ALL').html('TODOS'));

                    $newTask.find('h4.modal-title').html('Nova Tarefa');
                    $newTask.modal('show');
                });

                get.fail(function() {
                    showMessage({
                        type: 'error',
                        title: 'Erro',
                        text: 'Algo deu errado...'
                    });
                });
            },

            listUsers: function(e) {
                var get = $.getJSON(baseUrl + '/users');

                get.done(function(users) {
                    $('table#users tbody').empty();

                    users.forEach(function(user) {
                        var userView = new UserView(user);
                        userView.render();
                    });

                    var $listUsersModel = $('#listUsersModal');
                    $listUsersModel.modal('show');
                });

                get.fail(function() {
                    showMessage({
                        type: 'error',
                        title: 'Erro',
                        text: 'Algo deu errado...'
                    });
                });
            },
        });

        var Router = Backbone.Router.extend({
                routes: {
                    '': 'logIn' ,
                    'tasks': 'listTasks',
                    'tasks/:id': 'showTask'
                }
            }),
            router = new Router();

        router.on('route:logIn', function() {
            var view = new LogInView();
            view.render();
        });

        router.on('route:listTasks', function() {
            var view = new ListTasksView();
            view.render();
        });

        Backbone.history.start();
    });
    </script>
</body>
</html>